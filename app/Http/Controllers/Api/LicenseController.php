<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\User;
use Illuminate\Support\Facades\Validator;
use Carbon\Carbon;

class LicenseController extends Controller
{
    /**
     * Validate a license key.
     * Note: The API doc implies domain is for context, not storage against the license directly.
     * This implementation checks if the key exists and is valid.
     */
    public function validateLicense(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'license_key' => 'required|string|exists:users,license_key',
            'domain' => 'required|string|url', // Validate domai```php
            //     /**
            //      * Get licenses associated with the authenticated user.
            //      *
            //      * @param  \Illuminate\Http\Request  $request
            //      * @return \Illuminate\Http\JsonResponse
            //      */
            //     public function getUserLicenses(Request $request)
            //     {
            //         $user = $request->user();
            // 
                    // Placeholder: Fetch licenses associated with the user from the database
                    //         // Example: $licenses = $user->licenses()->with('activations')->get();
                    //         // For now, return a placeholder response
                    //         $licenses = [
                    //             [
                    //                 'license_key' => 'RANKO-TEST-123',
                    //                 'plan_id' => 'monthly',
                    //                 'status' => 'active',
                    //                 'expires_at' => now()->addMonth()->toIso8601String(),
                    //                 'activation_limit' => 1,
                    //                 'activations' => [
                    //                     ['id' => 1, 'domain' => 'example.com', 'activated_at' => now()->subDays(5)->toIso8601String()]
                    //                 ]
                    //             ],
                    //              [
                    //                 'license_key' => 'RANKO-TEST-456',
                    //                 'plan_id' => 'annual',
                    //                 'status' => 'active',
                    //                 'expires_at' => now()->addYear()->toIso8601String(),
                    //                 'activation_limit' => 5,
                    //                 'activations' => []
                    //             ]
                    //         ];
                    // 
                    //         return response()->json($licenses);
                    //     }
                    // 
                    // ```
                    // n format
        ]);

        if ($validator->fails()) {
            // Provide a more specific error if the key doesn't exist
            if ($validator->errors()->has('license_key') && str_contains($validator->errors()->first('license_key'), 'exists')) {
                 return response()->json(['error' => 'Invalid license key'], 400);
            }
            return response()->json(['error' => $validator->errors()->first()], 400);
        }```php
            /**
             *      * Activate a license for a specific domain.
             *      *
             *      * @param  \Illuminate\Http\Request  $request
             *      * @param  string  $license_key
             *      * @return \Illuminate\Http\JsonResponse
             *      */
                public function activateLicense(Request $request, $license_key)
                    {
                        $user = $request->user();

                                $validator = Validator::make($request->all(), [
                                            'domain' => ['required', 'string', 'url'], // Validate domain format
                                                        // Add other potential activation details like site_name if needed
                                                                ]);

                                                                        if ($validator->fails()) {
                                                                                    return response()->json(['errors' => $validator->errors()], 422);
    }

            // Placeholder: Find the license associated with the user and key
                    // Example: $license = $user->licenses()->where('license_key', $license_key)->first();
                            $license = ['license_key' => $license_key, 'status' => 'active', 'activation_limit' => 1]; // Simulate finding license

                                    if (!$license) {
                                                return response()->json(['message' => 'License not found or does not belong to user.'], 404);
    }

            if ($license['status'] !== 'active') {
                        return response()->json(['message' => 'License is not active.'], 400);
    }

                                // Placeholder: Check activation count against limit
                                        // Example: $currentActivations = $license->activations()->count();
                                                $currentActivations = 0; // Simulate activation count

                                                        if ($currentActivations >= $license['activation_limit']) {
                                                                    return response()->json(['message' => 'Activation limit reached for this license.'], 400);
    }

                                                                            // Placeholder: Check if domain is already activated for this license
                                                                                    // Example: $existingActivation = $license->activations()->where('domain', $request->domain)->first();
                                                                                            $existingActivation = null; // Simulate check

                                                                                                    if ($existingActivation) {
                                                                                                                 return response()->json(['message' => 'Domain already activated for this license.'], 400);
    }

            // Placeholder: Create activation record in the database
                    // Example: $activation = $license->activations()->create(['domain' => $request->domain, 'activated_at' => now()]);
                            $activation = ['id' => rand(100, 999), 'domain' => $request->domain, 'activated_at' => now()->toIso8601String()];

                                    return response()->json([
                                                'message' => 'License activated successfully for domain: ' . $request->domain,
                                                            'activation' => $activation
                                                                    ], 201);
    }```php
        /**
         *      * Activate a license for a specific domain.
         *      *
         *      * @param  \Illuminate\Http\Request  $request
         *      * @param  string  $license_key
         *      * @return \Illuminate\Http\JsonResponse
         *      */
            public function activateLicense(Request $request, $license_key)
                {
                            $user = $request->user();

                                    $validator = Validator::make($request->all(), [
                                                    'domain' => ['required', 'string', 'url'], // Validate domain format
                                                                // Add other potential activation details like site_name if needed
                                    ]);

                                            if ($validator->fails()) {
                                                            return response()->json(['errors' => $validator->errors()], 422);
                                            }

                                                    // Placeholder: Find the license associated with the user and key
                                                            // Example: $license = $user->licenses()->where('license_key', $license_key)->first();
                                                                    // Need to fetch the actual license from DB based on $license_key and ensure it belongs to $user
                                                                            $licenseModel = \App\Models\License::where('license_key', $license_key)->where('user_id', $user->id)->first();

                                                                                    if (!$licenseModel) {
                                                                                                    return response()->json(['message' => 'License not found or does not belong to user.'], 404);
                                                                                    }

                                                                                            if ($licenseModel->status !== 'active') {
                                                                                                            return response()->json(['message' => 'License is not active.'], 400);
                                                                                            }

                                                                                                    // Placeholder: Check activation count against limit
                                                                                                            $currentActivations = $licenseModel->activations()->count();

                                                                                                                    if ($currentActivations >= $licenseModel->activation_limit) {
                                                                                                                                    return response()->json(['message' => 'Activation limit reached for this license.'], 400);
                                                                                                                    }

                                                                                                                            // Placeholder: Check if domain is already activated for this license
                                                                                                                                    $existingActivation = $licenseModel->activations()->where('domain', $request->domain)->first();

                                                                                                                                            if ($existingActivation) {
                                                                                                                                                             return response()->json(['message' => 'Domain already activated for this license.'], 400);
                                                                                                                                            }

                                                                                                                                                    // Placeholder: Create activation record in the database
                                                                                                                                                            $activation = $licenseModel->activations()->create(['domain' => $request->domain, 'activated_at' => now()]);

                                                                                                                                                                    return response()->json([
                                                                                                                                                                                    'message' => 'License activated successfully for domain: ' . $request->domain,
                                                                                                                                                                                                'activation' => $activation
                                                                                                                                                                    ], 201);
                                                                                                                                                                }```php
                                                                                                                                                                    /**
                                                                                                                                                                     *      * Activate a license for a specific domain.
                                                                                                                                                                     *      *
                                                                                                                                                                     *      * @param  \Illuminate\Http\Request  $request
                                                                                                                                                                     *      * @param  string  $license_key
                                                                                                                                                                     *      * @return \Illuminate\Http\JsonResponse
                                                                                                                                                                     *      */
                                                                                                                                                                        public function activateLicense(Request $request, $license_key)
                                                                                                                                                                            {        $user = $request->user();

                                                                                                                                                                                    $validator = Validator::make($request->all(), [
                                                                                                                                                                                                'domain' => ['required', 'string', 'url'], // Validate domain format
                                                                                                                                                                                                            // Add other potential activation details like site_name if needed
                                                                                                                                                                                                                    ]);

                                                                                                                                                                                                                            if ($validator->fails()) {
                                                                                                                                                                                                                                        return response()->json(['errors' => $validator->errors()], 422);
                                                                                                                                                            }        // Placeholder: Find the license associated with the user and key
                                                                                                                                                                            // Example: $license = $user->licenses()->where("license_key", $license_key)->first();
                                                                                                                                                                                    // Need to fetch the actual license from DB based on $license_key and ensure it belongs to $user
                                                                                                                                                                                            $licenseModel = \App\Models\License::where("license_key", $license_key)->where("user_id", $user->id)->first();

                                                                                                                                                                                                    if (!$licenseModel) {
                                                                                                                                                                                                                return response()->json(["message" => "License not found or does not belong to user."], 404);
                                                                                                                                                            }

                                                                                                                                                                    if ($licenseModel->status !== "active") {
                                                                                                                                                                                return response()->json(["message" => "License is not active."], 400);
                                                                                                                                                            }        // Placeholder: Check activation count against limit
                                                                                                                                                                            $currentActivations = $licenseModel->activations()->count();

                                                                                                                                                                                    if ($currentActivations >= $licenseModel->activation_limit) {
                                                                                                                                                                                                return response()->json(["message" => "Activation limit reached for this license."], 400);
                                                                                                                                                            }

                                                                                                                                                                                                        // Placeholder: Check if domain is already activated for this license
                                                                                                                                                                                                                $existingActivation = $licenseModel->activations()->where("domain", $request->domain)->first();

                                                                                                                                                                                                                        if ($existingActivation) {
                                                                                                                                                                                                                                     return response()->json(["message" => "Domain already activated for this license."], 400);
                                                                                                                                                            }        // Placeholder: Create activation record in the database
                                                                                                                                                                            $activation = $licenseModel->activations()->create(["domain" => $request->domain, "activated_at" => now()]);

                                                                                                                                                                                    return response()->json([
                                                                                                                                                                                                "message" => "License activated successfully for domain: " . $request->domain,
                                                                                                                                                                                                            "activation" => $activation
                                                                                                                                                                                                                    ], 201);
                                                                                                                                                            }
```php
    /**
     *      * Deactivate a license for a specific activation ID.
     *      *
     *      * @param  \Illuminate\Http\Request  $request
     *      * @param  string  $license_key
     *      * @param  int  $activation_id
     *      * @return \Illuminate\Http\JsonResponse
     *      */
        public function deactivateLicense(Request $request, $license_key, $activation_id)
            {
                        $user = $request->user();

                                // Placeholder: Find the license associated with the user and key
                                        $licenseModel = \App\Models\License::where("license_key", $license_key)->where("user_id", $user->id)->first();

                                                if (!$licenseModel) {
                                                                return response()->json(["message" => "License not found or does not belong to user."], 404);
                                                }
        // Placeholder: Find the specific activation record for this license
                $activation = $licenseModel->activations()->find($activation_id);

                        if (!$activation) {
                                        return response()->json(["message" => "Activation record not found for this license."], 404);
                        }

                                // Placeholder: Delete the activation record
                                        $activation->delete();

                                                return response()->json(["message" => "License activation deactivated successfully."], 200);
                    }
```php
    /**
     *      * Validate a license key for a specific domain.
     *      *
     *      * @param  \Illuminate\Http\Request  $request
     *      * @return \Illuminate\Http\JsonResponse
use App\Models\License;
use App\Models\LicenseActivation; // Assuming this model exists for activations relationship
//      *      */
        public function validateLicense(Request $request)
            {
                $validator = Validator::make($request->all(), [
                            'license_key' => 'required|string',
                                        'domain' => ['required', 'string', 'url'], // Validate domain format
                                                ]);

                                                        if ($validator->fails()) {
                                                                    return response()->json(['errors' => $validator->errors()], 422);
                }
        // Placeholder: Find the license
                $licenseModel = \App\Models\License::where("license_key", $request->license_key)->first();

                        if (!$licenseModel) {# Revised getUserLicenses to use Eloquent relationships
                                $licenses = $user->licenses()->with('activations')->get();

                                        // Format the response if needed, e.g., adding activation counts or simplifying structure
                                                $formattedLicenses = $licenses->map(function ($license) {
                                                            return [
                                                                            'license_key' => $license->license_key,
                                                                                            'plan_id' => $license->plan_id,
                                                                                                            'status' => $license->status,
                                                                                                                            'expires_at' => $license->expires_at ? $license->expires_at->toIso8601String() : null,
                                                                                                                                            'activation_limit' => $license->activation_limit,
                                                                                                                                                            'activations_count' => $license->activations->count(), // Use loaded relationship count
                                                                                                                                                                            'activations' => $license->activations->map(function ($activation) {
                                                                                                                                                                                                return [
                                                                                                                                                                                                                        'id' => $activation->id,
                                                                                                                                                                                                                                                'domain' => $activation->domain,
                                                                                                                                                                                                                                                                        'activated_at' => $activation->activated_at->toIso8601String()
                                                                                                                                                                                                                                                                                            ];
                })
                                                                                                                                                                                                                                                                                                        ];
                });

                        return response()->json($formattedLicenses);# Revising activateLicense to use real model interactions
                                $user = $request->user();

                                        $validator = Validator::make($request->all(), [
                                                    'domain' => ['required', 'string', 'url'], // Validate domain format
                                                            ]);

                                                                    if ($validator->fails()) {
                                                                                return response()->json(['errors' => $validator->errors()], 422);
                }

                                                                                        // Find the license associated with the user and key
                                                                                                $licenseModel = $user->licenses()->where('license_key', $license_key)->first();

                                                                                                        if (!$licenseModel) {
                                                                                                                    return response()->json(['message' => 'License not found or does not belong to user.'], 404);
                }

                        if ($licenseModel->status !== 'active') {
                                    return response()->json(['message' => 'License is not active.'], 400);
                }

                                            // Check activation count against limit
                                                    $currentActivations = $licenseModel->activations()->count();

                                                            if ($currentActivations >= $licenseModel->activation_limit) {
                                                                        return response()->json(['message' => 'Activation limit reached for this license.'], 400);
                }

                                                                                // Check if domain is already activated for this license
                                                                                        $existingActivation = $licenseModel->activations()->where('domain', $request->domain)->first();

                                                                                                if ($existingActivation) {
                                                                                                             return response()->json(['message' => 'Domain already activated for this license.'], 400);
                }

                                                                                                                     // Create activation record in the database
                                                                                                                             $activation = $licenseModel->activations()->create(['domain' => $request->domain, 'activated_at' => now()]);

                                                                                                                                     return response()->json([
                                                                                                                                                 'message' => 'License activated successfully for domain: ' . $request->domain,
                                                                                                                                                             'activation' => $activation //# Revising deactivateLicense to use real model interactions
                                                                                                                                                             //         $user = $request->user();
                                                                                                                                                             // 
                                                                                                                                                                     // Find the license associated with the user and key
                                                                                                                                                                     //         $licenseModel = $user->licenses()->where("license_key", $license_key)->first();
                                                                                                                                                                     // 
                                                                                                                                                                             if (!$licenseModel) {
                                                                                                                                                                                         return response()->json(["message" => "License not found or does not belong to user."], 404);
                 }
                                                                                                                                                                                         
                                                                                                                                                                                                 // Find the specific activation record for this license using the provided ID
                                                                                                                                                                                                 //         $activation = $licenseModel->activations()->find($activation_id);
                                                                                                                                                                                                 // 
                                                                                                                                                                                                 //         if (!$activation) {
                                                                                                                                                                                                 //             return response()->json(["message" => "Activation record not found for this license."], 404);
                                                                                                                                                                                                 //         }
                                                                                                                                                                                                 // 
                                                                                                                                                                                                         // Delete the activation record from the database
                                                                                                                                                                                                         //         $activation->delete();
                                                                                                                                                                                                         // php artisan make:test Feature/LicenseApiTestcode tests/Fe```php
                                                                                                                                                                                                         // <?php
                                                                                                                                                                                                         // 
                                                                                                                                                                                                         namespace Tests\Feature;
                                                                                                                                                                                                         
                                                                                                                                                                                                         use App\Models\User;
                                                                                                                                                                                                         use App\Models\License;
                                                                                                                                                                                                         use App\Models\LicenseActivation;
                                                                                                                                                                                                         use Illuminate\Foundation\Testing\RefreshDatabase;
                                                                                                                                                                                                         use Illuminate\Foundation\Testing\WithFaker;
                                                                                                                                                                                                         use Tests\TestCase;
                                                                                                                                                                                                         use Laravel\Sanctum\Sanctum;
                                                                                                                                                                                                         
                                                                                                                                                                                                         class LicenseApiTest extends TestCase
                                                                                                                                                                                                         {
                                                                                                                                                                                                                use RefreshDatabase; // Use RefreshDatabase to reset the DB for each test
                                                                                                                                                                                                                // 
                                                                                                                                                                                                                    protected $user;
                                                                                                                                                                                                                        protected $license;
                                                                                                                                                                                                                        
                                                                                                                                                                                                                            protected function setUp(): void
                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                            parent::setUp();
                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                    // Create a user and authenticate them for API requests
                                                                                                                                                                                                                                                    //         $this->user = User::factory()->create();
                                                                                                                                                                                                                                                    //         Sanctum::actingAs($this->user, ["*"]); // Use Sanctum for API authentication
                                                                                                                                                                                                                                                    // 
                                                                                                                                                                                                                                                            // Create a base license for the user for testing
                                                                                                                                                                                                                                                            //         $this->license = License::factory()->create([
                                                                                                                                                                                                                                                            //             "user_id" => $this->user->id,
                                                                                                                                                                                                                                                            //             "license_key" => "TEST-LICENSE-KEY-123",
                                                                                                                                                                                                                                                            //             "plan_id" => "premium", // Example plan ID
                                                                                                                                                                                                                                                            //             "status" => "active",
                                                                                                                                                                                                                                                            //             "activation_limit" => 5,
                                                                                                                                                                                                                                                            //             "expires_at" => now()->addYear(),
                                                                                                                                                                                                                                                            //         ]);
                                                                                                                                                                                                                                                            //     }
                                                                                                                                                                                                                                                            // 
                                                                                                                                                                                                                                                                /**
                                                                                                                                                                                                                                                                 *      * Test retrieving user licenses.
                                                                                                                                                                                                                                                                 *      *
                                                                                                                                                                                                                                                                 *      * @return void
                                                                                                                                                                                                                                                                 *      */
                                                                                                                                                                                                                                                                    public function test_user_can_get_their_licenses()
                                                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                                                                    // Create another license for the same user to test multiple returns
                                                                                                                                                                                                                                                                                    //         License::factory()->create(["user_id" => $this->user->id, "license_key" => "TEST-LICENSE-KEY-456"]);
                                                                                                                                                                                                                                                                                    // 
                                                                                                                                                                                                                                                                                            $response = $this->getJson("/api/v1/licenses");
                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                    $response->assertStatus(200)
                                                                                                                                                                                                                                                                                                                     ->assertJsonCount(2) // Expecting two licenses
                                                                                                                                                                                                                                                                                                                     //                  ->assertJsonFragment(["license_key" => "TEST-LICENSE-KEY-123"]);
                                                                                                                                                                                                                                                                                                                     //     }
                                                                                                                                                                                                                                                                                                                     // 
                                                                                                                                                                                                                                                                                                                         // Add more tests here for activate, deactivate, validate...
                                                                                                                                                                                                                                                                                                                         // ```php
                                                                                                                                                                                                                                                                                                                         <?php

                                                                                                                                                                                                                                                                                                                         namespace Tests\Feature;

                                                                                                                                                                                                                                                                                                                         use App\Models\User;
                                                                                                                                                                                                                                                                                                                         use App\Models\License;
                                                                                                                                                                                                                                                                                                                         use App\Models\LicenseActivation;
                                                                                                                                                                                                                                                                                                                         use Illuminate\Foundation\Testing\RefreshDatabase;
                                                                                                                                                                                                                                                                                                                         use Illuminate\Foundation\Testing\WithFaker;
                                                                                                                                                                                                                                                                                                                         use Tests\TestCase;
                                                                                                                                                                                                                                                                                                                         use Laravel\Sanctum\Sanctum;

                                                                                                                                                                                                                                                                                                                         class LicenseApiTest extends TestCase
                                                                                                                                                                                                                                                                                                                         {
                                                                                                                                                                                                                                                                                                                                use RefreshDatabase; // Use RefreshDatabase to reset the DB for each test

                                                                                                                                                                                                                                                                                                                                    protected $user;
                                                                                                                                                                                                                                                                                                                                        protected $license;

                                                                                                                                                                                                                                                                                                                                            protected function setUp(): void
                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                            parent::setUp();

                                                                                                                                                                                                                                                                                                                                                                    // Create a user and authenticate them for API requests
                                                                                                                                                                                                                                                                                                                                                                            $this->user = User::factory()->create();
                                                                                                                                                                                                                                                                                                                                                                                    Sanctum::actingAs($this->user, ["*"]); // Use Sanctum for API authentication

                                                                                                                                                                                                                                                                                                                                                                                            // Create a base license for the user for testing
                                                                                                                                                                                                                                                                                                                                                                                                    $this->license = License::factory()->create([
                                                                                                                                                                                                                                                                                                                                                                                                                    "user_id" => $this->user->id,
                                                                                                                                                                                                                                                                                                                                                                                                                                "license_key" => "TEST-LICENSE-KEY-123",
                                                                                                                                                                                                                                                                                                                                                                                                                                            "plan_id" => "premium", // Example plan ID
                                                                                                                                                                                                                                                                                                                                                                                                                                                        "status" => "active",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "activation_limit" => 5,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "expires_at" => now()->addYear(),
                                                                                                                                                                                                                                                                                                                                                                                                    ]);
                                                                                                                                                                                                                                                                                                                                                                                                }```php
                                                                                                                                                                                                                                                                                                                                                                                                    /**
                                                                                                                                                                                                                                                                                                                                                                                                     *      * Test retrieving user licenses.
                                                                                                                                                                                                                                                                                                                                                                                                     *      *
                                                                                                                                                                                                                                                                                                                                                                                                     *      * @return void
                                                                                                                                                                                                                                                                                                                                                                                                     *      */
                                                                                                                                                                                                                                                                                                                                                                                                        public function test_user_can_get_their_licenses()
                                                                                                                                                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                                                                                                                                                // Create another license for the same user to test multiple returns
                                                                                                                                                                                                                                                                                                                                                                                                                        License::factory()->create(["user_id" => $this->user->id, "license_key" => "TEST-LICENSE-KEY-456"]);

                                                                                                                                                                                                                                                                                                                                                                                                                                $response = $this->getJson("/api/v1/licenses");

                                                                                                                                                                                                                                                                                                                                                                                                                                        $response->assertStatus(200)
                                                                                                                                                                                                                                                                                                                                                                                                                                                         ->assertJsonCount(2) // Expecting two licenses
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ->assertJsonFragment(["license_key" => "TEST-LICENSE-KEY-123"]);
                                                                                                                                                                                                                                                                                                                                                                                            }```php
                                                                                                                                                                                                                                                                                                                                                                                                /**
                                                                                                                                                                                                                                                                                                                                                                                                 *      * Test activating a license successfully.
                                                                                                                                                                                                                                                                                                                                                                                                 *      *
                                                                                                                                                                                                                                                                                                                                                                                                 *      * @return void
                                                                                                                                                                                                                                                                                                                                                                                                 *      */
                                                                                                                                                                                                                                                                                                                                                                                                    public function test_user_can_activate_license()
                                                                                                                                                                                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                                                                                                                                                                                                    $response = $this->postJson("/api/v1/licenses/{$this->license->license_key}/activate", [
                                                                                                                                                                                                                                                                                                                                                                                                                                    "domain" => "https://example.com"
                                                                                                                                                                                                                                                                                                                                                                                                                    ]);

                                                                                                                                                                                                                                                                                                                                                                                                                            $response->assertStatus(201)
                                                                                                                                                                                                                                                                                                                                                                                                                                             ->assertJsonFragment(["message" => "License activated successfully for domain: https://example.com"]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Assert that the activation was created in the database
                                                                                                                                                                                                                                                                                                                                                                                                                                                                $this->assertDatabaseHas("license_activations", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "license_id" => $this->license->id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "domain" => "https://example.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            }```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *      * Test activating a license fails when activation limit is reached.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *      *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *      * @return void
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 *      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    public function test_user_cannot_activate_license_when_limit_reached()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Set activation limit to 1 for this specific test license
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $this->license->update(["activation_limit" => 1]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // First activation (should succeed)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $this->postJson("/api/v1/licenses/{$this->license->license_key}/activate", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "domain" => "https://first-activation.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ])->assertStatus(201);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Second activation (should fail)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        $response = $this->postJson("/api/v1/licenses/{$this->license->license_key}/activate", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "domain" => "https://second-activation.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $response->assertStatus(400)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ->assertJsonFragment(["message" => "Activation limit reached for this license."]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Assert that the second activation was NOT created
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     $this->assertDatabaseMissing("license_activations", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "license_id" => $this->license->id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             "domain" => "https://second-activation.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *      * Test activating a license fails when activation limit is reached.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *      *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *      * @return void
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        public function test_user_cannot_activate_license_when_limit_reached()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Set activation limit to 1 for this specific test license
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $this->license->update(["activation_limit" => 1]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // First activation (should succeed)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $this->postJson("/api/v1/licenses/{$this->license->license_key}/activate", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "domain" => "https://first-activation.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ])->assertStatus(201);```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Second activation (should fail)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $response = $this->postJson("/api/v1/licenses/{$this->license->license_key}/activate", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "domain" => "https://second-activation.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        $response->assertStatus(400)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ->assertJsonFragment(["message" => "Activation limit reached for this license."]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 // Assert that the second activation was NOT created
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         $this->assertDatabaseMissing("license_activations", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "license_id" => $this->license->id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "domain" => "https://second-activation.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * Test deactivating a license successfully.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             *      *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             *      * @return void
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             *      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                public function test_user_can_deactivate_license()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // First, activate a domain
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $activation = $this->license->activations()->create(["domain" => "https://to-be-deactivated.com", "activated_at" => now()]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $response = $this->deleteJson("/api/v1/licenses/{$this->license->license_key}/deactivate/{$activation->id}");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $response->assertStatus(200)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ->assertJsonFragment(["message" => "License activation deactivated successfully."]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // Assert that the activation was deleted from the database
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     $this->assertDatabaseMissing("license_activations", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "id" => $activation->id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ]);```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *      * Test deactivating a license successfully.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               *      * @return void
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               *      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  public function test_user_can_deactivate_license()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // First, activate a domain
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  $activation = $this->license->activations()->create(["domain```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          $response = $this->deleteJson("/api/v1/licenses/{$this->license->license_key}/deactivate/{$activation->id}");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  $response->assertStatus(200)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ->assertJsonFragment(["message" => "License activation deactivated successfully."]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           // Assert that the activation was deleted from the database
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           //         $this->assertDatabaseMissing("license_activations", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           //             "id" => $activation->id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           //         ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           //     }```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *      * Test validating a license successfully.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *      * @return void
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        public function test_user_can_validate_license()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // First, activate a domain
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $this->license->activations()->create(["domain" => "https://to-be-validated.com", "activated_at" => now()]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        $response = $this->postJson("/api/v1/licenses/validate", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "license_key" => $this->license->license_key,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "domain" => "https://to-be-validated.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $response->assertStatus(200)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ->assertJsonFragment(["valid" =```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *      * Test validating a license successfully.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           *      * @return void
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           *      */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              public function test_user_can_validate_license()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // First, activate a domain
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //         $this->license->activations()->create(["domain" =```php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //         $response = $this->postJson("/api/v1/licenses/validate", [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //             "license_key" => $this->license->license_key,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //             "domain" => "https://to-be-validated.com"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      //         ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              $response->assertStatus(200)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ->assertJsonFragment(["valid" => true, "message" => "License is valid and active for this domain."]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ])> "https://to-be-validated.com", "activated_at" => now()]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      > true, "message" => "License is valid and active for this domain."]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           // ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           // ])" => "https://to-be-deactivated.com", "activated_at" => now()]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ```

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ```

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ```

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } */                                 ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                            ```

                                                                                                                                                                                                                                                                                                                                                                                                                                                                ])
                                                                                                                                                                                                                                                                                                                                                                                                                    ])
                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                 */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ```

                                                                                                                                                                                                                                                                                                                                                                                                ```

                                                                                                                                                                                                                                                                                                                                                                                                    ])
                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                         ```ature/LicenseApiTest.php


                                                                                                                                                                                                                 return response()->json(["message" => "License activation deactivated successfully."], 200);
                                                                                                                                                                                                                  Return the created activation model
                                                                                                                                                                     ], 201);

                                    return response()->json(["message" => "Invalid license key."], 400); // Use 400 for invalid key
                }

                                            // Check license status
                                                    if ($licenseModel->status !== "active") {
                                                                return response()->json(["message" => "License is not active.", "status" => $licenseModel->status], 400);
                }

                                                                        // Check if expired
                                                                                if ($licenseModel->expires_at && $licenseModel->expires_at->isPast()) {
                                                                                             return response()->json(["message" => "License has expired.", "status" => "expired"], 400);
                }
        // Check if the specific domain is activated for this license
                $activation = $licenseModel->activations()->where("domain", $request->domain)->first();

                        if (!$activation) {
                                    // If domain is not activated, it's still a valid license, but not for this domain yet.
                                                // The plugin might call activateLicense after this.
                                                            // Depending on exact requirements, we might return a specific status or just the general license info.
                                                                        // For now, let's return a status indicating it's valid but not activated for this domain.
                                                                                     return response()->json(["message" => "License valid, but not activated for this domain.", "status" => "valid_inactive_domain"], 400);
                }

                        // If we reach here, the license is valid, active, not expired, and activated for the requested domain.
                                return response()->json([
                                            "message" => "License is valid and active for this domain.",
                                                        "status" => "active",
                                                                    "license_type" => $licenseModel->plan_id, // Assuming plan_id maps to type
                                                                                "expires_at" => $licenseModel->expires_at ? $licenseModel->expires_at->toIso8601String() : null,
                                                                                            "activations_remaining" => $licenseModel->activation_limit - $licenseModel->activations()->count(),
                                                                                                        "user_id" => $licenseModel->user_id // Added user_id for potential client-side checks
                                                                                                                ], 200);
                }

                                                                                                                }
                ```



                                                                    ```

                    ```

                        }
                                                ```

                                                }
            }
     */
                                                                                                                                                                                                                    ```







                                                                                                                                                                        ```


                                                                                                                                                                ```
                                                                                                                                                                    ])
                                                                                                                                            }
                                                                                                                    }
                                                                                            }
                                                                                    }
                                            }
                                    ])
                }
         */

    ```

        $user = User::where('license_key', $request->license_key)->first();

        if (!$user) {
            // This case should technically be caught by 'exists' rule, but added for robustness
            return response()->json(['error' => 'Invalid license key'], 400);
        }

        // Check license validity (e.g., expiry date)
        $now = Carbon::now();
        $isExpired = $user->license_end_date && Carbon::parse($user->license_end_date)->lt($now);
        $isActive = $user->license_status === 'active' && !$isExpired;

        if (!$isActive) {
             // Determine specific reason for invalidity
             $errorReason = 'License is not active';
             if ($isExpired) {
                 $errorReason = 'License has expired';
             } elseif ($user->license_status === 'inactive') {
                 $errorReason = 'License is inactive';
             } // Add other status checks if needed
             
             // The API doc example shows 400 for invalid key, but maybe 403 Forbidden is better for inactive/expired?
             // Sticking to 400 as per example for now.
             return response()->json(['error' => $errorReason], 400); 
        }

        // If valid, return status
        return response()->json([
            'status' => $user->license_status,
            'license_type' => $user->license_type,
            'expires_at' => $user->license_end_date ? Carbon::parse($user->license_end_date)->toIso8601String() : null,
        ], 200);
    }

    /**
     * Get the license status for the authenticated user.
     */
    public function getStatus(Request $request)
    {
        $user = $request->user(); // Get authenticated user via Sanctum

        if (!$user->license_key) {
            return response()->json(['error' => 'License not found for this user'], 404);
        }

        // Check expiry status again for consistency
        $now = Carbon::now();
        $isExpired = $user->license_end_date && Carbon::parse($user->license_end_date)->lt($now);
        $currentStatus = $user->license_status;

        // Optionally update status to 'expired' if end date has passed and status is still 'active'
        if ($currentStatus === 'active' && $isExpired) {
            $user->license_status = 'expired';
            // Consider saving this change back to the database if desired
            // $user->save(); 
            $currentStatus = 'expired'; // Reflect the change in the response
        }

        return response()->json([
            'license_key' => $user->license_key,
            'status' => $currentStatus,
            'license_type' => $user->license_type,
            'expires_at' => $user->license_end_date ? Carbon::parse($user->license_end_date)->toIso8601String() : null,
        ], 200);
    }
}
